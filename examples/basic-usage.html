<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArtistAPhoto - Basic Usage</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .main-layout {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    @media (max-width: 1024px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }
    .controls-column {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .preview-column {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 20px;
      height: fit-content;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .container h2 {
      margin-top: 0;
      font-size: 18px;
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    .controls {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    button {
      padding: 10px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .undo-redo button {
      background: #6c757d;
    }
    .undo-redo button:hover:not(:disabled) {
      background: #545b62;
    }
    .load-sample {
      background: #28a745;
      margin-top: 10px;
      width: 100%;
    }
    .load-sample:hover {
      background: #218838;
    }
    input[type="file"] {
      padding: 10px;
      border: 2px dashed #007bff;
      border-radius: 4px;
      width: 100%;
      cursor: pointer;
      font-size: 13px;
    }
    .canvas-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .canvas-wrapper {
      text-align: center;
    }
    .canvas-wrapper h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #666;
    }
    canvas {
      max-width: 100%;
      height: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fafafa;
    }
    .slider-group {
      margin-bottom: 12px;
    }
    .slider-group label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 13px;
      font-weight: bold;
      color: #555;
    }
    input[type="range"] {
      width: 100%;
      margin-bottom: 5px;
    }
    .slider-value {
      color: #007bff;
      font-weight: bold;
    }
    .apply-adjustments {
      width: 100%;
      background: #17a2b8;
      margin-top: 10px;
    }
    .apply-adjustments:hover {
      background: #138496;
    }
    .export-buttons {
      display: flex;
      gap: 8px;
    }
    .export-buttons button {
      flex: 1;
      font-size: 12px;
    }
    .no-image-message {
      padding: 40px;
      text-align: center;
      color: #999;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>üé® ArtistAPhoto SDK - Demo</h1>

  <!-- License Activation Section -->
  <div id="licenseSection" class="container" style="max-width: 1400px; margin: 0 auto 20px auto; background: #fff3cd; border: 1px solid #ffc107;">
    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 20px;">‚ö†Ô∏è</span>
        <span style="color: #856404; font-size: 14px;">
          <strong>Modo Trial:</strong> Exporta√ß√µes ter√£o watermark.
          <a href="https://polar.sh/artistaphoto" target="_blank" style="color: #856404;">Compre uma licen√ßa</a> para remover.
        </span>
      </div>
      <div style="display: flex; gap: 10px; align-items: center;">
        <input
          type="text"
          id="licenseKeyInput"
          placeholder="License key"
          style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; font-family: monospace; width: 200px;"
        >
        <button
          onclick="activateLicense()"
          id="activateLicenseBtn"
          style="padding: 8px 16px; font-size: 13px; white-space: nowrap;"
        >
          Ativar
        </button>
        <button
          onclick="enableDevMode()"
          style="background: #6c757d; padding: 8px 12px; font-size: 12px;"
          title="Apenas para desenvolvimento local"
        >
          üîß Dev
        </button>
      </div>
    </div>
    <div id="licenseStatus" style="padding: 10px; border-radius: 4px; display: none; margin-top: 10px;"></div>
  </div>

  <!-- License Valid Message -->
  <div id="licenseValidMessage" class="container" style="max-width: 600px; margin: 0 auto 20px auto; display: none; background: #d4edda; border: 1px solid #c3e6cb;">
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <div>
        <strong style="color: #155724;">‚úÖ Licen√ßa Ativada</strong>
        <span id="licenseInfoText" style="color: #155724; margin-left: 10px; font-size: 13px;"></span>
      </div>
      <button onclick="clearLicense()" style="background: #dc3545; padding: 6px 12px; font-size: 12px;">
        Desativar
      </button>
    </div>
  </div>

  <div class="main-layout" id="editorSection">
    <!-- Coluna de Controles (Esquerda) -->
    <div class="controls-column">
      <div class="container">
        <h2>üìÅ Carregar Imagem</h2>
        <input type="file" id="fileInput" accept="image/*">
        <button class="load-sample" onclick="loadSampleImage()">üì∏ Usar Imagem de Exemplo</button>
      </div>

      <div class="container">
        <h2>‚úÇÔ∏è Crop</h2>
        <div class="crop-inputs">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
            <div>
              <label style="font-size: 12px; color: #666;">X:</label>
              <input type="number" id="cropX" value="50" min="0" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 12px; color: #666;">Y:</label>
              <input type="number" id="cropY" value="50" min="0" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 12px; color: #666;">Width:</label>
              <input type="number" id="cropWidth" value="300" min="1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 12px; color: #666;">Height:</label>
              <input type="number" id="cropHeight" value="300" min="1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button onclick="setCropSquare()" style="background: #6c757d; font-size: 12px; padding: 8px;">üìê Quadrado</button>
            <button class="apply-adjustments" onclick="applyCrop()" style="font-size: 12px; padding: 8px;">‚úÇÔ∏è Aplicar</button>
          </div>
        </div>
      </div>

      <div class="container">
        <h2>üìê Resize</h2>
        <div class="resize-inputs">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
            <div>
              <label style="font-size: 12px; color: #666;">Width:</label>
              <input type="number" id="resizeWidth" value="400" min="1"
                     oninput="updateResizeHeight()"
                     style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 12px; color: #666;">Height:</label>
              <input type="number" id="resizeHeight" value="300" min="1"
                     oninput="updateResizeWidth()"
                     style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
          <div style="margin-bottom: 10px;">
            <label style="font-size: 12px; color: #666; display: flex; align-items: center; gap: 5px; cursor: pointer;">
              <input type="checkbox" id="maintainAspect" checked>
              Manter propor√ß√£o (aspect ratio)
            </label>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button onclick="resetResizeToCurrentSize()" style="background: #6c757d; font-size: 12px; padding: 8px;">üîÑ Tamanho Atual</button>
            <button class="apply-adjustments" onclick="applyResize()" style="font-size: 12px; padding: 8px;">üìê Aplicar</button>
          </div>
        </div>
      </div>

      <div class="container">
        <h2>‚úçÔ∏è Adicionar Texto</h2>
        <div class="text-inputs">
          <div style="margin-bottom: 10px;">
            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Texto:</label>
            <input type="text" id="textContent" value="Hello World" placeholder="Digite o texto..."
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px;">
            <div>
              <label style="font-size: 12px; color: #666;">X:</label>
              <input type="number" id="textX" value="50" min="0"
                     style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 12px; color: #666;">Y:</label>
              <input type="number" id="textY" value="50" min="0"
                     style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 12px; color: #666;">Tamanho:</label>
              <input type="number" id="textSize" value="32" min="8" max="200"
                     style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px; margin-bottom: 10px;">
            <div>
              <label style="font-size: 12px; color: #666;">Fonte:</label>
              <select id="textFont" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="Arial">Arial</option>
                <option value="Helvetica">Helvetica</option>
                <option value="Times New Roman">Times New Roman</option>
                <option value="Courier New">Courier New</option>
                <option value="Georgia">Georgia</option>
                <option value="Verdana">Verdana</option>
                <option value="Comic Sans MS">Comic Sans MS</option>
                <option value="Impact">Impact</option>
              </select>
            </div>
            <div>
              <label style="font-size: 12px; color: #666;">Cor:</label>
              <input type="color" id="textColor" value="#000000"
                     style="width: 100%; height: 34px; padding: 2px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
            </div>
          </div>

          <div style="display: flex; gap: 10px; margin-bottom: 10px; font-size: 12px;">
            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
              <input type="checkbox" id="textBold">
              <strong>Negrito</strong>
            </label>
            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
              <input type="checkbox" id="textItalic">
              <em>It√°lico</em>
            </label>
            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
              <input type="checkbox" id="textStroke">
              Contorno
            </label>
            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
              <input type="checkbox" id="textShadow">
              Sombra
            </label>
          </div>

          <button class="apply-adjustments" onclick="applyText()" style="width: 100%;">‚úçÔ∏è Adicionar Texto</button>
        </div>
      </div>

      <div class="container">
        <h2>üî∑ Adicionar Shapes</h2>
        <div class="shape-inputs">
          <div style="margin-bottom: 10px;">
            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Tipo:</label>
            <select id="shapeType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="rectangle">Ret√¢ngulo</option>
              <option value="ellipse">Elipse</option>
            </select>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
            <div>
              <label style="font-size: 12px; color: #666;">X:</label>
              <input type="number" id="shapeX" value="50" min="0"
                     style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 12px; color: #666;">Y:</label>
              <input type="number" id="shapeY" value="50" min="0"
                     style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
            <div>
              <label style="font-size: 12px; color: #666;">Largura:</label>
              <input type="number" id="shapeWidth" value="100" min="1"
                     style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 12px; color: #666;">Altura:</label>
              <input type="number" id="shapeHeight" value="100" min="1"
                     style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>

          <div style="margin-bottom: 10px;">
            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">Cor de Preenchimento:</label>
            <input type="color" id="shapeFill" value="#FF0000"
                   style="width: 100%; height: 34px; padding: 2px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
          </div>

          <div style="display: flex; gap: 10px; margin-bottom: 10px; font-size: 12px;">
            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
              <input type="checkbox" id="shapeStroke">
              Contorno
            </label>
          </div>

          <button class="apply-adjustments" onclick="applyShape()" style="width: 100%;">üî∑ Adicionar Shape</button>
        </div>
      </div>

      <div class="container">
        <h2>üé® Filtros</h2>
        <div class="controls">
          <button onclick="applyFilter('grayscale')">Grayscale</button>
          <button onclick="applyFilter('sepia')">Sepia</button>
          <button onclick="applyFilter('blur')">Blur</button>
          <button onclick="applyFilter('sharpen')">Sharpen</button>
          <button onclick="applyFilter('vintage')">Vintage</button>
          <button onclick="applyFilter('invert')">Invert</button>
          <button onclick="applyFilter('vignette')">Vignette</button>
          <button onclick="applyFilter('posterize')">Posterize</button>
          <button onclick="applyFilter('pixelate')">Pixelate</button>
          <button onclick="applyFilter('edgeDetection')">Edge Detect</button>
        </div>
      </div>

      <div class="container">
        <h2>‚öôÔ∏è Ajustes</h2>
        <div class="slider-group">
          <label>
            <span>Brightness</span>
            <span class="slider-value" id="brightnessValue">0</span>
          </label>
          <input type="range" id="brightness" min="-100" max="100" value="0"
                 oninput="updateSliderValue('brightness')">
        </div>
        <div class="slider-group">
          <label>
            <span>Contrast</span>
            <span class="slider-value" id="contrastValue">0</span>
          </label>
          <input type="range" id="contrast" min="-100" max="100" value="0"
                 oninput="updateSliderValue('contrast')">
        </div>
        <div class="slider-group">
          <label>
            <span>Saturation</span>
            <span class="slider-value" id="saturationValue">0</span>
          </label>
          <input type="range" id="saturation" min="-100" max="100" value="0"
                 oninput="updateSliderValue('saturation')">
        </div>
        <div class="slider-group">
          <label>
            <span>Exposure</span>
            <span class="slider-value" id="exposureValue">0</span>
          </label>
          <input type="range" id="exposure" min="-100" max="100" value="0"
                 oninput="updateSliderValue('exposure')">
        </div>
        <div class="slider-group">
          <label>
            <span>Temperature</span>
            <span class="slider-value" id="temperatureValue">0</span>
          </label>
          <input type="range" id="temperature" min="-100" max="100" value="0"
                 oninput="updateSliderValue('temperature')">
        </div>
        <button class="apply-adjustments" onclick="applyAdjustments()">‚úì Aplicar Ajustes</button>
      </div>

      <div class="container">
        <h2>‚Ü©Ô∏è Undo/Redo</h2>
        <div class="controls undo-redo">
          <button id="undoBtn" onclick="undo()" disabled>‚Üê Undo</button>
          <button id="redoBtn" onclick="redo()" disabled>Redo ‚Üí</button>
          <button onclick="reset()">üîÑ Reset</button>
        </div>
      </div>

      <div class="container">
        <h2>üíæ Export</h2>
        <div class="export-buttons">
          <button onclick="downloadImage('jpeg')">JPEG</button>
          <button onclick="downloadImage('png')">PNG</button>
          <button onclick="downloadImage('webp')">WebP</button>
        </div>
      </div>
    </div>

    <!-- Coluna de Preview (Direita) -->
    <div class="preview-column">
      <h2>üëÅÔ∏è Preview</h2>
      <div class="canvas-container" id="canvasContainer">
        <div class="no-image-message">
          Carregue uma imagem para come√ßar
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { ArtistAPhoto, LicenseError } from '../dist/index.mjs';

    let editor = null;
    let isLicenseActive = false;

    // ==================== License Management ====================

    // Verifica se j√° existe licen√ßa em cache ao carregar a p√°gina
    async function checkExistingLicense() {
      // Tenta recuperar licen√ßa do localStorage
      const cachedLicense = localStorage.getItem('artistaphoto_license_cache');
      if (cachedLicense) {
        try {
          const cached = JSON.parse(cachedLicense);
          if (cached.expiresAt > Date.now()) {
            // Tem cache v√°lido, tenta usar a key salva
            const savedKey = localStorage.getItem('artistaphoto_user_key');
            if (savedKey) {
              document.getElementById('licenseKeyInput').value = savedKey;
              await activateLicense(true); // silencioso
              return;
            }
          }
        } catch (e) {
          console.log('Cache inv√°lido, necess√°rio ativar licen√ßa');
        }
      }
    }

    // Ativa a licen√ßa
    window.activateLicense = async function(silent = false) {
      const input = document.getElementById('licenseKeyInput');
      const key = input.value.trim();
      const statusDiv = document.getElementById('licenseStatus');
      const btn = document.getElementById('activateLicenseBtn');

      if (!key) {
        if (!silent) {
          statusDiv.style.display = 'block';
          statusDiv.style.background = '#fff3cd';
          statusDiv.style.color = '#856404';
          statusDiv.textContent = '‚ö†Ô∏è Por favor, insira uma license key';
        }
        return;
      }

      btn.disabled = true;
      btn.textContent = '...';
      statusDiv.style.display = 'none';

      try {
        const licenseInfo = await ArtistAPhoto.setLicenseKey(key);

        // Salva a key do usu√°rio para recuperar depois
        localStorage.setItem('artistaphoto_user_key', key);

        // Sucesso!
        isLicenseActive = true;
        showLicenseSuccess(licenseInfo);

      } catch (error) {
        if (!silent) {
          statusDiv.style.display = 'block';
          statusDiv.style.background = '#f8d7da';
          statusDiv.style.color = '#721c24';

          if (error instanceof LicenseError) {
            statusDiv.innerHTML = `‚ùå <strong>${error.code}</strong><br>${error.message.replace(/\n/g, '<br>')}`;
          } else {
            statusDiv.textContent = `‚ùå Erro: ${error.message}`;
          }
        }

        btn.disabled = false;
        btn.textContent = 'Ativar';
      }
    };

    // Mostra sucesso da licen√ßa
    function showLicenseSuccess(licenseInfo) {
      // Esconde se√ß√£o de input
      document.getElementById('licenseSection').style.display = 'none';

      // Mostra mensagem de sucesso
      const validMessage = document.getElementById('licenseValidMessage');
      validMessage.style.display = 'block';
      validMessage.style.maxWidth = '1400px';

      // Mostra info da licen√ßa
      const infoText = document.getElementById('licenseInfoText');
      if (licenseInfo.expiresAt) {
        const expiresDate = new Date(licenseInfo.expiresAt).toLocaleDateString('pt-BR');
        infoText.textContent = `Expira em: ${expiresDate}`;
      }
    }

    // Limpa a licen√ßa
    window.clearLicense = function() {
      ArtistAPhoto.clearLicense();
      localStorage.removeItem('artistaphoto_user_key');
      isLicenseActive = false;

      // Mostra se√ß√£o de input novamente (banner de trial)
      document.getElementById('licenseSection').style.display = 'block';
      document.getElementById('licenseValidMessage').style.display = 'none';

      // Limpa input
      document.getElementById('licenseKeyInput').value = '';
      document.getElementById('activateLicenseBtn').disabled = false;
      document.getElementById('activateLicenseBtn').textContent = 'Ativar';
    };

    // Ativa modo de desenvolvimento (sem valida√ß√£o de licen√ßa)
    window.enableDevMode = function() {
      ArtistAPhoto.enableDevMode();
      isLicenseActive = true;

      const licenseInfo = ArtistAPhoto.getLicenseInfo();
      showLicenseSuccess(licenseInfo);

      // Muda a mensagem para indicar modo dev
      document.getElementById('licenseValidMessage').style.background = '#fff3cd';
      document.getElementById('licenseValidMessage').style.borderColor = '#ffc107';
      document.querySelector('#licenseValidMessage strong').textContent = 'üîß Modo Desenvolvimento';
      document.querySelector('#licenseValidMessage strong').style.color = '#856404';
      document.getElementById('licenseInfoText').textContent = 'Valida√ß√£o de licen√ßa desativada';
      document.getElementById('licenseInfoText').style.color = '#856404';
    };

    // Verifica licen√ßa ao carregar a p√°gina
    checkExistingLicense();

    // ==================== Canvas Functions ====================

    // Cria estrutura de canvas
    function createCanvasStructure() {
      const container = document.getElementById('canvasContainer');
      container.innerHTML = `
        <div class="canvas-wrapper">
          <h3>Original</h3>
          <canvas id="originalCanvas"></canvas>
        </div>
        <div class="canvas-wrapper">
          <h3>Editada</h3>
          <canvas id="previewCanvas"></canvas>
        </div>
      `;
    }

    // Atualiza preview
    async function updatePreview() {
      if (!editor) return;

      const canvas = await editor.preview();
      const previewCanvas = document.getElementById('previewCanvas');
      const ctx = previewCanvas.getContext('2d');

      previewCanvas.width = canvas.width;
      previewCanvas.height = canvas.height;
      ctx.drawImage(canvas, 0, 0);

      updateUndoRedoButtons();
    }

    // Atualiza bot√µes de undo/redo
    function updateUndoRedoButtons() {
      document.getElementById('undoBtn').disabled = !editor.canUndo();
      document.getElementById('redoBtn').disabled = !editor.canRedo();
    }

    // Atualiza valores padr√£o de crop e resize
    function updateDefaultValues() {
      const imgWidth = editor.getOriginal().width;
      const imgHeight = editor.getOriginal().height;

      // Atualizar aspect ratio
      aspectRatio = imgWidth / imgHeight;

      // Atualizar valores de crop (20% das bordas)
      document.getElementById('cropX').value = Math.floor(imgWidth * 0.1);
      document.getElementById('cropY').value = Math.floor(imgHeight * 0.1);
      document.getElementById('cropWidth').value = Math.floor(imgWidth * 0.8);
      document.getElementById('cropHeight').value = Math.floor(imgHeight * 0.8);

      // Atualizar valores de resize (tamanho original)
      document.getElementById('resizeWidth').value = imgWidth;
      document.getElementById('resizeHeight').value = imgHeight;
    }

    // Carregar imagem
    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        editor = await ArtistAPhoto.fromFile(file);

        // Criar estrutura de canvas
        createCanvasStructure();

        // Mostrar original
        const originalCanvas = document.getElementById('originalCanvas');
        const originalCtx = originalCanvas.getContext('2d');
        originalCanvas.width = editor.getOriginal().width;
        originalCanvas.height = editor.getOriginal().height;
        originalCtx.putImageData(editor.getOriginal(), 0, 0);

        // Atualizar valores padr√£o
        updateDefaultValues();

        await updatePreview();
      } catch (error) {
        alert('Erro ao carregar imagem: ' + error.message);
      }
    });

    // Fun√ß√µes globais
    window.loadSampleImage = async () => {
      // Cria uma imagem de exemplo com gradiente
      const canvas = document.createElement('canvas');
      canvas.width = 600;
      canvas.height = 400;
      const ctx = canvas.getContext('2d');

      // Gradiente
      const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
      gradient.addColorStop(0, '#667eea');
      gradient.addColorStop(0.5, '#764ba2');
      gradient.addColorStop(1, '#f093fb');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // C√≠rculos decorativos
      ctx.globalAlpha = 0.3;
      ctx.fillStyle = 'white';
      ctx.beginPath();
      ctx.arc(100, 100, 80, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(500, 300, 100, 0, Math.PI * 2);
      ctx.fill();
      ctx.globalAlpha = 1.0;

      // Texto
      ctx.fillStyle = 'white';
      ctx.font = 'bold 56px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
      ctx.shadowBlur = 10;
      ctx.fillText('ArtistAPhoto', canvas.width / 2, canvas.height / 2);
      ctx.shadowBlur = 0;

      editor = await ArtistAPhoto.fromCanvas(canvas);

      // Criar estrutura de canvas
      createCanvasStructure();

      // Mostrar original
      const originalCanvas = document.getElementById('originalCanvas');
      const originalCtx = originalCanvas.getContext('2d');
      originalCanvas.width = canvas.width;
      originalCanvas.height = canvas.height;
      originalCtx.drawImage(canvas, 0, 0);

      // Atualizar valores padr√£o
      updateDefaultValues();

      await updatePreview();
    };

    window.setCropSquare = () => {
      if (!editor) {
        alert('Carregue uma imagem primeiro!');
        return;
      }

      const imgWidth = editor.getOriginal().width;
      const imgHeight = editor.getOriginal().height;
      const size = Math.min(imgWidth, imgHeight);
      const x = Math.floor((imgWidth - size) / 2);
      const y = Math.floor((imgHeight - size) / 2);

      document.getElementById('cropX').value = x;
      document.getElementById('cropY').value = y;
      document.getElementById('cropWidth').value = size;
      document.getElementById('cropHeight').value = size;
    };

    window.applyCrop = async () => {
      if (!editor) {
        alert('Carregue uma imagem primeiro!');
        return;
      }

      const x = parseInt(document.getElementById('cropX').value);
      const y = parseInt(document.getElementById('cropY').value);
      const width = parseInt(document.getElementById('cropWidth').value);
      const height = parseInt(document.getElementById('cropHeight').value);

      try {
        editor.crop({ x, y, width, height });
        await updatePreview();

        // Atualizar aspect ratio e valores de resize ap√≥s crop
        aspectRatio = width / height;
        document.getElementById('resizeWidth').value = width;
        document.getElementById('resizeHeight').value = height;
      } catch (error) {
        alert('Erro ao aplicar crop: ' + error.message);
      }
    };

    let aspectRatio = 1;
    let isUpdating = false;

    window.resetResizeToCurrentSize = async () => {
      if (!editor) {
        alert('Carregue uma imagem primeiro!');
        return;
      }

      const canvas = await editor.preview();
      document.getElementById('resizeWidth').value = canvas.width;
      document.getElementById('resizeHeight').value = canvas.height;
      aspectRatio = canvas.width / canvas.height;
    };

    window.updateResizeHeight = () => {
      if (!document.getElementById('maintainAspect').checked || isUpdating) return;

      isUpdating = true;
      const width = parseInt(document.getElementById('resizeWidth').value);
      const height = Math.round(width / aspectRatio);
      document.getElementById('resizeHeight').value = height;
      isUpdating = false;
    };

    window.updateResizeWidth = () => {
      if (!document.getElementById('maintainAspect').checked || isUpdating) return;

      isUpdating = true;
      const height = parseInt(document.getElementById('resizeHeight').value);
      const width = Math.round(height * aspectRatio);
      document.getElementById('resizeWidth').value = width;
      isUpdating = false;
    };

    window.applyResize = async () => {
      if (!editor) {
        alert('Carregue uma imagem primeiro!');
        return;
      }

      const width = parseInt(document.getElementById('resizeWidth').value);
      const height = parseInt(document.getElementById('resizeHeight').value);
      const maintainAspectRatio = document.getElementById('maintainAspect').checked;

      try {
        editor.resize(width, height, {
          quality: 'high',
          maintainAspectRatio
        });
        await updatePreview();

        // Atualizar aspect ratio ap√≥s resize
        aspectRatio = width / height;
      } catch (error) {
        alert('Erro ao aplicar resize: ' + error.message);
      }
    };

    window.applyText = async () => {
      if (!editor) {
        alert('Carregue uma imagem primeiro!');
        return;
      }

      const text = document.getElementById('textContent').value;
      if (!text) {
        alert('Digite um texto primeiro!');
        return;
      }

      const x = parseInt(document.getElementById('textX').value);
      const y = parseInt(document.getElementById('textY').value);
      const fontSize = parseInt(document.getElementById('textSize').value);
      const fontFamily = document.getElementById('textFont').value;
      const color = document.getElementById('textColor').value;
      const bold = document.getElementById('textBold').checked;
      const italic = document.getElementById('textItalic').checked;
      const hasStroke = document.getElementById('textStroke').checked;
      const hasShadow = document.getElementById('textShadow').checked;

      const options = {
        text,
        x,
        y,
        fontSize,
        fontFamily,
        color,
        bold,
        italic,
      };

      // Adicionar contorno se habilitado
      if (hasStroke) {
        options.stroke = {
          color: color === '#000000' ? '#FFFFFF' : '#000000', // Cor oposta
          width: 2
        };
      }

      // Adicionar sombra se habilitado
      if (hasShadow) {
        options.shadow = {
          color: 'rgba(0, 0, 0, 0.5)',
          blur: 4,
          offsetX: 2,
          offsetY: 2
        };
      }

      try {
        editor.addText(options);
        await updatePreview();
      } catch (error) {
        alert('Erro ao adicionar texto: ' + error.message);
      }
    };

    window.applyShape = async () => {
      if (!editor) {
        alert('Carregue uma imagem primeiro!');
        return;
      }

      const type = document.getElementById('shapeType').value;
      const x = parseInt(document.getElementById('shapeX').value);
      const y = parseInt(document.getElementById('shapeY').value);
      const width = parseInt(document.getElementById('shapeWidth').value);
      const height = parseInt(document.getElementById('shapeHeight').value);
      const fill = document.getElementById('shapeFill').value;
      const hasStroke = document.getElementById('shapeStroke').checked;

      const options = {
        type,
        x,
        y,
        width,
        height,
        fill,
      };

      // Adicionar contorno se habilitado
      if (hasStroke) {
        options.stroke = {
          color: fill === '#FF0000' ? '#000000' : '#FFFFFF', // Cor contrastante
          width: 3
        };
      }

      try {
        editor.addShape(options);
        await updatePreview();
      } catch (error) {
        alert('Erro ao adicionar shape: ' + error.message);
      }
    };

    window.applyFilter = async (filterType) => {
      if (!editor) {
        alert('Carregue uma imagem primeiro!');
        return;
      }

      editor.filter(filterType, 0.8);
      await updatePreview();
    };

    window.updateSliderValue = (type) => {
      const slider = document.getElementById(type);
      const valueSpan = document.getElementById(type + 'Value');
      valueSpan.textContent = slider.value;
    };

    window.applyAdjustments = async () => {
      if (!editor) {
        alert('Carregue uma imagem primeiro!');
        return;
      }

      const brightness = parseInt(document.getElementById('brightness').value);
      const contrast = parseInt(document.getElementById('contrast').value);
      const saturation = parseInt(document.getElementById('saturation').value);
      const exposure = parseInt(document.getElementById('exposure').value);
      const temperature = parseInt(document.getElementById('temperature').value);

      if (brightness !== 0) editor.brightness(brightness);
      if (contrast !== 0) editor.contrast(contrast);
      if (saturation !== 0) editor.saturation(saturation);
      if (exposure !== 0) editor.exposure(exposure);
      if (temperature !== 0) editor.temperature(temperature);

      await updatePreview();

      // Reset sliders
      ['brightness', 'contrast', 'saturation', 'exposure', 'temperature'].forEach(type => {
        document.getElementById(type).value = 0;
        document.getElementById(type + 'Value').textContent = '0';
      });
    };

    window.undo = async () => {
      if (!editor) return;
      editor.undo();
      await updatePreview();
    };

    window.redo = async () => {
      if (!editor) return;
      editor.redo();
      await updatePreview();
    };

    window.reset = async () => {
      if (!editor) return;
      editor.reset();
      await updatePreview();
    };

    window.downloadImage = async (format) => {
      if (!editor) {
        alert('Carregue uma imagem primeiro!');
        return;
      }

      const formatMap = {
        jpeg: 'image/jpeg',
        png: 'image/png',
        webp: 'image/webp'
      };

      await editor.download(`artistaphoto-edited.${format}`, formatMap[format], 0.9);
    };
  </script>
</body>
</html>
